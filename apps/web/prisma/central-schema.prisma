// Central database schema for authentication and user data
// All user finance data (transactions, categories, etc.) is stored here

generator client {
  provider = "prisma-client-js"
  output   = "../../node_modules/.prisma/central-client"
}

datasource db {
  provider = "postgresql"
  url      = env("CENTRAL_DATABASE_URL")
}

// ============================================================================
// Better Auth Tables
// These tables are required by Better Auth and follow their schema conventions
// ============================================================================

model User {
  id            String    @id
  name          String
  email         String    @unique
  emailVerified Boolean   @default(false) @map("email_verified")
  image         String?
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Waitlist/approval status: pending, approved, rejected
  status        String    @default("pending")
  approvedAt    DateTime? @map("approved_at")

  // Auth relations
  sessions      Session[]
  accounts      Account[]

  // Plaid relations
  plaidItems    PlaidItem[]

  // Finance data relations
  financeAccounts     FinanceAccount[]
  categories          Category[]
  transactions        Transaction[]
  categorizationRules CategorizationRule[]

  @@map("users")
}

model Session {
  id        String   @id
  expiresAt DateTime @map("expires_at")
  token     String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  userId    String   @map("user_id")

  // Custom fields for device session locking
  deviceId      String?  @map("device_id")
  deviceName    String?  @map("device_name")
  isActive      Boolean  @default(true) @map("is_active")
  lastHeartbeat DateTime @default(now()) @map("last_heartbeat")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Account {
  id                    String    @id
  accountId             String    @map("account_id")
  providerId            String    @map("provider_id")
  userId                String    @map("user_id")
  accessToken           String?   @map("access_token")
  refreshToken          String?   @map("refresh_token")
  idToken               String?   @map("id_token")
  accessTokenExpiresAt  DateTime? @map("access_token_expires_at")
  refreshTokenExpiresAt DateTime? @map("refresh_token_expires_at")
  scope                 String?
  password              String?   // Hashed password for email/password auth
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("accounts")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime @map("expires_at")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("verifications")
}

// ============================================================================
// Custom Tables for Somar
// ============================================================================

// Plaid connections - stored centrally because access tokens must stay server-side
model PlaidItem {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  accessToken     String    @map("access_token")
  institutionId   String    @map("institution_id")
  institutionName String    @map("institution_name")
  cursor          String?   // For incremental transaction sync
  lastSyncedAt    DateTime? @map("last_synced_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  deletedAt       DateTime? @map("deleted_at") // Soft delete - keeps access token for recovery

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Plaid accounts metadata (not the full data - that's in user's encrypted DB)
  plaidAccounts PlaidAccountMeta[]

  @@map("plaid_items")
}

// Minimal Plaid account metadata for syncing purposes
model PlaidAccountMeta {
  id             String  @id @default(uuid())
  plaidItemId    String  @map("plaid_item_id")
  plaidAccountId String  @map("plaid_account_id") // Plaid's account ID
  name           String
  type           String  // Plaid account type (depository, credit, loan, etc.)
  subtype        String? // Plaid account subtype (checking, savings, credit card, etc.)

  plaidItem PlaidItem @relation(fields: [plaidItemId], references: [id], onDelete: Cascade)

  @@unique([plaidItemId, plaidAccountId])
  @@map("plaid_account_meta")
}

// ============================================================================
// User Finance Data
// ============================================================================

// Bank/financial accounts (different from Better Auth Account model)
model FinanceAccount {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  name           String
  type           String   // checking, credit_card, investment, loan
  plaidAccountId String?  @map("plaid_account_id")
  createdAt      DateTime @default(now()) @map("created_at")

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@map("finance_accounts")
}

// Transaction categories
model Category {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  name      String
  type      String   @default("spending") // spending, income, transfer
  color     String   @default("#6366f1")
  createdAt DateTime @default(now()) @map("created_at")

  user         User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]
  budgets      CategoryBudget[]
  rules        CategorizationRule[]

  @@unique([userId, name])
  @@map("categories")
}

// Monthly budgets per category
model CategoryBudget {
  id         String   @id @default(uuid())
  categoryId String   @map("category_id")
  amount     Float
  startMonth String   @map("start_month") // YYYY-MM format
  createdAt  DateTime @default(now()) @map("created_at")

  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId, startMonth])
  @@map("category_budgets")
}

// Financial transactions
model Transaction {
  id                       String   @id @default(uuid())
  userId                   String   @map("user_id")
  accountId                String   @map("account_id")
  categoryId               String?  @map("category_id")
  description              String
  amount                   Float    // negative = expense, positive = income
  date                     DateTime @db.Date
  excluded                 Boolean  @default(false)
  isConfirmed              Boolean  @default(false) @map("is_confirmed")
  createdAt                DateTime @default(now()) @map("created_at")
  plaidTransactionId       String?  @unique @map("plaid_transaction_id")
  plaidOriginalDescription String?  @map("plaid_original_description")
  plaidName                String?  @map("plaid_name")
  plaidMerchantName        String?  @map("plaid_merchant_name")
  plaidAuthorizedDate      DateTime?  @db.Date @map("plaid_authorized_date")
  plaidPostedDate          DateTime?  @db.Date @map("plaid_posted_date")

  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  account  FinanceAccount  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  category Category?       @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([userId, date])
  @@index([accountId])
  @@index([categoryId])
  @@index([isConfirmed])
  @@map("transactions")
}

// Learned merchant patterns for auto-categorization
model CategorizationRule {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  pattern    String
  categoryId String   @map("category_id")
  isPreset   Boolean  @default(false) @map("is_preset")
  createdAt  DateTime @default(now()) @map("created_at")

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
  @@map("categorization_rules")
}

